name: Deploy Database Migrations

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  migrate:
    name: Run SQL Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Uses the Supabase Management API (HTTPS/IPv4) to run SQL.
      # Bypasses direct DB connection entirely — no psql, no IPv6 issues.
      # Required secrets:
      #   SUPABASE_ACCESS_TOKEN  — PAT from supabase.com/dashboard/account/tokens
      #   SUPABASE_PROJECT_ID    — project reference (e.g. uqfqkvslxoucxmxxrobt)
      - name: Run /sql scripts
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          PASS=0; FAIL=0
          API="https://api.supabase.com/v1/projects/${SUPABASE_PROJECT_ID}/database/query"
          for f in sql/*.sql; do
            [ -f "$f" ] || continue
            echo "-> $f"
            STATUS=$(python3 -c "
          import json, sys, urllib.request, urllib.error
          sql = open('$f').read()
          req = urllib.request.Request(
            '$API',
            data=json.dumps({'query': sql}).encode(),
            headers={'Content-Type': 'application/json',
                     'Authorization': 'Bearer $SUPABASE_ACCESS_TOKEN'}
          )
          try:
            resp = urllib.request.urlopen(req)
            print('ok')
          except urllib.error.HTTPError as e:
            body = e.read().decode()
            print(f'err:{e.code}:{body[:200]}')
          ")
            if echo "$STATUS" | grep -q "^ok"; then
              echo "   done"
              PASS=$((PASS+1))
            else
              echo "   errors: $STATUS"
              FAIL=$((FAIL+1))
            fi
          done
          echo "sql/: $PASS passed, $FAIL failed"

      - name: Run supabase/migrations scripts
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          PASS=0; FAIL=0
          API="https://api.supabase.com/v1/projects/${SUPABASE_PROJECT_ID}/database/query"
          for f in supabase/migrations/*.sql; do
            [ -f "$f" ] || continue
            echo "-> $f"
            STATUS=$(python3 -c "
          import json, sys, urllib.request, urllib.error
          sql = open('$f').read()
          req = urllib.request.Request(
            '$API',
            data=json.dumps({'query': sql}).encode(),
            headers={'Content-Type': 'application/json',
                     'Authorization': 'Bearer $SUPABASE_ACCESS_TOKEN'}
          )
          try:
            resp = urllib.request.urlopen(req)
            print('ok')
          except urllib.error.HTTPError as e:
            body = e.read().decode()
            print(f'err:{e.code}:{body[:200]}')
          ")
            if echo "$STATUS" | grep -q "^ok"; then
              echo "   done"
              PASS=$((PASS+1))
            else
              echo "   errors: $STATUS"
              FAIL=$((FAIL+1))
            fi
          done
          echo "supabase/migrations/: $PASS passed, $FAIL failed"
